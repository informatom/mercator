function foldertree() {
  $("#foldertree").fancytree({
    source: { url: "/contentmanager/front/show_foldertree" },
    extensions: ["dnd"],
    selectMode: 1,
    dnd: {
      droppable: {
        activeClass: "ui-state-default",
        hoverClass: "ui-state-hover"
      },
      dragStart: function() {
        return true
      },
      dragEnter: function() {
        return true
      },
      dragDrop: function(node, data) {
        if( !data.otherNode ){
          // It's a non-tree draggable
          var draggable = data.draggable.element[0]
          var contentElementId = parseInt(draggable.id.split("-")[2])

          Messenger().run({
            progressMessage: '<%= I18n.t("activerecord.attribute_help.content_element.moving") %>',
            successMessage: '<%= I18n.t("activerecord.attribute_help.content_element.moved") %>',
            errorMessage: '<%= I18n.t("activerecord.attribute_help.content_element.move_failed") %>',
            hideAfter: 3
          },{
            url:"/contentmanager/front/update_content_element/" + contentElementId,
            method: "POST",
            data: {
              authenticity_token: csrf_token,
              folder_id: data.node.key
            },
            dataType: 'script',
            success: function(response) {
              w2ui['contentelementsgrid'].load('/contentmanager/front/show_content_elements/' + response)
            }
          })

        } else {
          // It's a tree draggable
          data.otherNode.moveTo(node, data.hitMode)

          Messenger().run({
            progressMessage: '<%= I18n.t("activerecord.attribute_help.folder.updating") %>',
            successMessage: '<%= I18n.t("activerecord.attribute_help.folder.updated") %>',
            errorMessage: '<%= I18n.t("activerecord.attribute_help.folder.update_failed") %>',
            hideAfter: 3
          },{
            url:"/contentmanager/front/update_folders",
            method: "POST",
            data: {
              authenticity_token: csrf_token,
              folders: $("#foldertree").fancytree("getTree").toDict()
            },
            dataType: 'script'
          })
        }
      }
    },
    click: function(event, data) {
      loadGridAndGallery(data.node.key)
    }
  })

  if (selected_folder_id) {
    setTimeout(
      function(){
        $("#foldertree").fancytree("getTree").getNodeByKey(selected_folder_id).setActive();
        loadGridAndGallery(selected_folder_id)
        setTimeout(
          function(){
            var index = w2ui.contentelementsgrid.get(selected_content_element_id, true)
            w2ui.contentelementsgrid.scrollIntoView(index)
            w2ui['contentelementsgrid'].select(selected_content_element_id)
          },
        4000 )
      },
    1000 )
  }
}

function loadGridAndGallery(content_element_id, set_element) {
  w2ui['contentelementsgrid'].load('/contentmanager/front/show_content_elements/' + content_element_id)
  $.ajax({
    url: "/contentmanager/front/get_thumbnails/" + content_element_id,
    context: document.body
  }).done(function(response) {
    $("#gallery").html(response)
    registerGallery()
  })
}