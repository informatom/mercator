function valueForm() {
  $('#valueForm').w2form({
    name: 'valueForm',
    fields : [
      {
        name: 'state',
        type: 'list',
        required : true,
        options: {
          items: [
            { id: 'textual', text: '<%= I18n.t("activerecord.attributes.property/datatypes.textual") %>'},
            { id: 'numeric', text: '<%= I18n.t("activerecord.attributes.property/datatypes.numeric") %>'},
            { id: 'flag', text: '<%= I18n.t("activerecord.attributes.property/datatypes.flag") %>'}
          ]
        },
        html: { caption: 'Type'}
      },
      { name: 'title_de',   type: 'text',     html: { caption: '<%= I18n.t("attributes.title") %> DE'}  },
      { name: 'title_en',   type: 'text',     html: { caption: '<%= I18n.t("attributes.title") %> EN'}  },
      { name: 'amount',     type: 'float',    html: { caption: '<%= I18n.t("attributes.amount") %>'}    },
      { name: 'unit_de',    type: 'text',     html: { caption: '<%= I18n.t("attributes.unit") %> DE'}   },
      { name: 'unit_en',    type: 'text',     html: { caption: '<%= I18n.t("attributes.unit") %> EN'}   },
      { name: 'flag',       type: 'checkbox', html: { caption: '<%= I18n.t("activerecord.attributes.property/datatypes.flag") %>'}   },
      { name: 'created_at', type: 'text',     html: { caption: '<%= I18n.t("attributes.created_at") %>' }, disabled: true },
      { name: 'updated_at', type: 'text',     html: { caption: '<%= I18n.t("attributes.updated_at") %>' }, disabled: true }
    ],
    onChange: function(event) {
      event.onComplete = function () {
        var the_state = w2ui.valueForm.record['state'].id
        updateFieldVisibility(the_state)
      }
    },
    onLoad: function(event) {
      event.onComplete = function () {
        var the_state = w2ui.valueForm.record['state']
        updateFieldVisibility(the_state)
      }
    },
    actions: {
      save: { 
        caption: 'Save', 
        class: 'w2ui-btn-green',
        onClick: function () {
          var tree = $("#valueTree").fancytree("getTree")
          var active_node = tree.getActiveNode()

          this.save( function() {
            tree.reload().done(function() {
              tree.activateKey(active_node.key)
            })
          })
        }
      },
      delete: { 
        caption: 'Delete', 
        class: 'w2ui-btn-red',
        onClick: function () {
          var form = this
          var tree =  $("#valueTree").fancytree("getTree")
          var active_node = tree.getActiveNode()
          property_group = active_node.parent

          $.ajax({
            url:"/productmanager/property_manager/value/" + active_node.key,
            method: "DELETE",
            data: { authenticity_token: csrf_token },
            dataType: 'script',
          }).done(function(response, textStatus, jqXHR) {
            form.clear()
            tree.reload().done(function() {
              tree.activateKey(property_group.key).setExpanded() 
            })
          }).fail(function(jqXHR, textStatus, errorThrown) {
            w2alert(jqXHR.responseText)
            w2popup.lock.unlock()
          })
        }
      }
    }  
  })
}

function updateFieldVisibility(the_state) {
  switch (the_state) {
    case 'numeric':
      $.each(['flag', 'title_de', 'title_en'], function( index, field ) {
        w2ui.valueForm.set(field, {disabled: true})
        w2ui.valueForm.record[field] = null
      })
      $.each(['amount', 'unit_de', 'unit_en'], function( index, field ) {
        w2ui.valueForm.set(field, {disabled: false})
      })
    break
    case 'textual':
      $.each(['flag', 'amount' ], function( index, field ) {
        w2ui.valueForm.set(field, {disabled: true})
        w2ui.valueForm.record[field] = null
      })
      $.each(['title_de', 'title_en', 'unit_de', 'unit_en'], function( index, field ) {
        w2ui.valueForm.set(field, {disabled: false})
      })
    break
    case 'flag':
      w2ui.valueForm.set('flag', {disabled: false})
      $.each(['amount','title_de', 'title_en', 'unit_de', 'unit_en'], function( index, field ) {
        w2ui.valueForm.set(field, {disabled: true})
        w2ui.valueForm.record[field] = null
      })
    break
  }
  w2ui.valueForm.refresh()
}
