<def tag="feedback-page" for="Conversation">
  <page title="#{ht 'conversation.feedback.title', :default=>['Feedback']}" merge>

    <body: class="lifecycle-transition-page feedback-page" param/>

    <content-header: param>
    </content-header:>

    <content-body: param>
      <form lifecycle="feedback" merge param="default">
        <div class="row">
          <error-messages param/>
          <input type="hidden"
                 name="key"
                 value="&this.lifecycle.provided_key"
                 if="&this.lifecycle.provided_key"/>
          <div class="col-lg-6">
            <photo width="100%" name="feedback-icon" />
          </div>
          <div class="col-lg-6">
            <textarea class="text conversation-content"
                      for="text"
                      id="conversation_content"
                      rows="25"
                      name="conversation[content]"
                      style="width:100%;
                             height: auto;
                             background-image: none;
                             background-position: 0% 0%;
                             background-repeat: repeat;"
                      placeholder="#{I18n.translate('mercator.feedback_placeholder')}">
            </textarea>
          </div>
        </div>

        <div class="row">
          <div class="col-lg-6">
            <h3><t key="mercator.protocol.one" /></h3>
            <p><t key="mercator.protocol.data_to_be_stored" /></p>

            <input checked="checked" name="conversation[mode]" type="radio" value="all" />
            <t key="mercator.protocol.text_customer_sales" /><br/>
            <input name="conversation[mode]" type="radio" value="consultant" />
            <t key="mercator.protocol.text_sales" /><br/>
            <input name="conversation[mode]" type="radio" value="user" />
            <t key="mercator.protocol.text_customer" /><br/>
            <input name="conversation[mode]" type="radio" value="none" />
            <t key="mercator.protocol.text" />
          </div>

          <div class="col-lg-6">
            <div param="actions">
              <submit label="#{t 'activerecord.attributes.conversation.lifecycle.transitions.feedback'}" param/>
              <or-cancel param="cancel"/>
            </div>
          </div>
        </div>
      </form>
    </content-body:>
  </page>
</def>

<extend tag="initiate-page" for="Conversation">
  <old-initiate-page merge>
    <before-form:>
      <div class="row">
        <div class="col-md-9">
          <div class="alert alert-info">
            <view with="&this.messages.first" />
          </div>
        </div>
        <div class="col-md-3">
          <photo-card with="&User.robot" />
        </div>
      </div>
    </before-form:>
  </old-initiate-page>
</extend>


<extend tag="show-page" for="Conversation">
  <old-show-page merge>
    <content-header: replace/>
    <content-body:>
      <h2><photo name="video-chat" width="32" style="vertical-align: super;"/> <t key="activerecord.models.conversation.one"/></h2>
      <h4>&nbsp; &nbsp; &nbsp; &nbsp; "<view:name />" <t key="mercator.from"/> <view:created-at /></h4>
      <br/>
      <div class="row">
        <div class="col-md-8" id="middle-column">
          <div class="panel panel-default">
            <div class="panel-heading">
              <if:consultant>
                <div class="media">
                  <div class="media-left">
                    <%= image_tag(this.photo.url(:thumb),  class: "media-object img-polaroid" ) %>
                  </div>
                  <div class="media-body">
                    <t key="mercator.your_consultant"/>:<br/><br/>
                    <view:first-name/> <view:surname/>
                  </div>
                </div>
              </if>
            </div>

            <div class="panel-body">
              <section param="collection-section" merge>
                <div part="messages">
                  <collection: with="&this.messages.limit(5).reverse"/>
                </div>
              </section>
            </div>

            <div class="panel-footer">
              <form with="&@message" update="mymessages">
                <input:content class="input-block-level form-control"
                               placeholder="#{I18n.translate('mercator.your_message')}" />
              </form>
            </div>
          </div>
        </div>

        <div class="col-md-4 moveable" id="right-column">
          <section param="collection-section" merge>
            <h3 param="collection-heading" class="blue"> <%= t("attributes.offers") %> </h3>
            <collection:offers part="offers"/>
          </section>

          <section param="collection-section" merge>
            <h3 param="collection-heading" class="blue"> <%= t("attributes.suggestions") %> </h3>
            <collection:suggestions part="suggestions"/>
          </section>

          <section param="collection-section" merge>
            <h3 param="collection-heading" class="blue"> <%= t("attributes.downloads") %> </h3>
            <ul class="list-group">
              <collection:downloads part="downloads"/>
            </ul>
          </section>

          <section param="collection-section" merge>
            <h3 param="collection-heading" class="blue"> <%= t("attributes.links") %> </h3>
            <ul class="list-group">
              <collection:links part="links"/>
            </ul>
          </section>


          <h3 class="blue"><t key="activerecord.models.feedback.one" /></h3>
          <p><t key="mercator.feedback_request" />:</p>
          <p><my-transition-link transition="feedback" method="get" class="btn-primary"/></p>
        </div>
      </div>

      <!-- Form and Scripts for refreshing content dynamically -->
      <%= subscribe_to "/conversations/" + this.id.to_s %>

      <form id="messages-form" style="display:none;" action="refresh" update="messages">
        <input name="id" value="#{this.id}" type="hidden"/>
      </form>

      <form id="links-form" style="display:none;" action="refresh" update="links">
        <input name="id" value="#{this.id}" type="hidden"/>
      </form>

      <form id="downloads-form" style="display:none;" action="refresh" update="downloads">
        <input name="id" value="#{this.id}" type="hidden"/>
      </form>

      <form id="offers-form" style="display:none;" action="refresh" update="offers">
        <input name="id" value="#{this.id}" type="hidden"/>
      </form>

      <script>
          PrivatePub.subscribe("/conversations/<%= this.id.to_s -%>", function(data, channel) {
            $("form#" + data.type + "-form").submit();
          });
      </script>
    </content-body:>
  </old-show-page>
</extend>