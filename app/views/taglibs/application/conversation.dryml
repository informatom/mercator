<def tag="feedback-page" for="Conversation">
  <page title="#{ht 'conversation.feedback.title', :default=>['Feedback']}" merge>

    <body: class="lifecycle-transition-page feedback-page" param/>

    <content-header: param>
    </content-header:>

    <content-body: param>
      <div class="container glow">
        <form lifecycle="feedback" merge param="default">
          <div class="row">
            <error-messages param/>
            <input type="hidden" name="key" value="&this.lifecycle.provided_key" if="&this.lifecycle.provided_key"/>
            <div class="col-lg-6">
              <photo width="100%" name="feedback-icon" />
            </div>
            <div class="col-lg-6">
              <textarea class="text conversation-content"
                        for="text"
                        id="conversation_content"
                        rows="25"
                        name="conversation[content]"
                        style="width:100%;
                               height: auto;
                               background-image: none;
                               background-position: 0% 0%;
                               background-repeat: repeat;"
                        placeholder="#{I18n.translate('mercator.feedback_placeholder')}">
              </textarea>
            </div>
          </div>

          <div class="row">
            <div class="col-lg-6">
              <h3><t key="mercator.protocol.one" /></h3>
              <p><t key="mercator.protocol.data_to_be_stored" /></p>

              <input checked="checked" name="conversation[mode]" type="radio" value="all" /> <t key="mercator.protocol.text_customer_sales" /><br/>
              <input name="conversation[mode]" type="radio" value="consultant" /> <t key="mercator.protocol.text_sales" /><br/>
              <input name="conversation[mode]" type="radio" value="user" /> <t key="mercator.protocol.text_customer" /><br/>
              <input name="conversation[mode]" type="radio" value="none" /> <t key="mercator.protocol.text" />
            </div>

            <div class="col-lg-6">
              <div param="actions">
                <submit label="#{t 'activerecord.attributes.conversation.lifecycle.transitions.feedback', :default=>['Feedback']}" param/><or-cancel param="cancel"/>
              </div>
            </div>
          </div>
        </form>
      </div>
    </content-body:>
  </page>
</def>

<extend tag="initiate-page" for="Conversation">
  <old-initiate-page merge>
    <before-form:>
      <photo-card with="&User.robot" class="pull-right" />
      <div class="alert alert-info">
        <view with="&this.messages.first" />
      </div>
    </before-form:>
  </old-initiate-page>
</extend>


<extend tag="show-page" for="Conversation">
  <old-show-page merge>
    <content-header: replace/>
    <content-body:>
      <div class="row">
        <div class="col-md-8 moveable" id="left-column">
          <form with="&@message" update="mymessages">
            <h3><t key="mercator.your_message" />: </h3>
            <div> <input:content class="input-block-level"/> </div>
          </form>

          <%= subscribe_to "/conversations/" + this.id.to_s %>

          <form id="messages-form" style="display:none;" action="refresh" update="messages">
            <input name="id" value="#{this.id}" type="hidden"/>
          </form>

          <form id="links-form" style="display:none;" action="refresh" update="links">
            <input name="id" value="#{this.id}" type="hidden"/>
          </form>

          <form id="downloads-form" style="display:none;" action="refresh" update="downloads">
            <input name="id" value="#{this.id}" type="hidden"/>
          </form>

          <form id="offers-form" style="display:none;" action="refresh" update="offers">
            <input name="id" value="#{this.id}" type="hidden"/>
          </form>

          <script>
              PrivatePub.subscribe("/conversations/<%= this.id.to_s -%>", function(data, channel) {
                $("form#" + data.type + "-form").submit();
              });
          </script>

          <section param="collection-section" merge>
            <collection:messages part="messages"/>
          </section>

          <section param="collection-section" merge>
            <h3 param="collection-heading"> <%= t("attributes.offers") %> </h3>
            <collection:offers part="offers"/>
          </section>

          <section param="collection-section" merge>
            <h3 param="collection-heading"> <%= t("attributes.downloads") %> </h3>
            <collection:downloads part="downloads"/>
          </section>

          <div part="links">
            <if test="&this.last_link && this.last_link.url.length > 7 && Time.now - this.last_link.created_at < 10">
              <script>
                $('#left-column').removeClass('col-md-8').addClass('col-md-2');
                $('#middle-column').removeClass('col-md-0 hidden').addClass('col-md-8');
                $('#middle-column').html($('#cobrowsing-area').html());
                $('#right-column').removeClass('col-md-4').addClass('col-md-2');
                $('.bootstrap-content').addClass('widescreen')
              </script>
              <div id="cobrowsing-area" class="hidden">
                <iframe src="#{this.last_link.url}" width="100%" height="800">
                  <p>
                    <t key="mercator.messages.conversation.no_frames" />:
                    <a href="&this.last_link.url">Link</a>
                  </p>
                </iframe>
              </div>
            </if>
            <else>
              <script>
                $('#left-column').removeClass('col-md-2').addClass('col-md-8');
                $('#middle-column').removeClass('col-md-8').addClass('hidden col-md-0');
                $('#right-column').removeClass('col-md-2').addClass('col-md-4');
                $('.bootstrap-content').removeClass('widescreen');
              </script>
            </else>
          </div>
        </div>
        <div class="col-md-0 moveable" id="middle-column"></div>
        <div class="col-md-4 moveable" id="right-column">

          <photo-card with="&this.consultant" />

          <section param="collection-section" merge>
            <h3 param="collection-heading"> <%= t("attributes.suggestions") %> </h3>
            <collection:suggestions part="suggestions"/>
          </section>

          <h3><t key="activerecord.models.feedback.one" /></h3>
          <p><t key="mercator.feedback_request" />:</p>
          <p><my-transition-link transition="feedback" method="get" class="btn-primary"/></p>
        </div>
      </div>
    </content-body:>
  </old-show-page>
</extend>